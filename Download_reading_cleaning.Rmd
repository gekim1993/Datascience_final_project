---
title: "Final project: The relationship between restaurant geographical distribution and chronic disease outcomes in New York City"
author: "Gaeun Kim(gk2501); Junting Ren(jr3755);  Leyiyu Yue(ly2428); Ruiwei Zhang(rz2375) ; "
date: "November 20, 2017"
output: 
   html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(readxl)
library(data.table)
library(stringr)
library(janitor)
```

```{r reading the New York Inspection data}
library(tidyverse)
library(httr)
library(jsonlite)

get_all_inspections = function(url) {
  
  all_inspections = vector("list", length = 0)
  
  loop_index = 1
  chunk_size = 50000
  DO_NEXT = TRUE
  
  while (DO_NEXT) {
    message("Getting data, page ", loop_index)
    
    all_inspections[[loop_index]] = 
      GET(url,
          query = list(`$order` = "zipcode",
                       `$limit` = chunk_size,
                       `$offset` = as.integer((loop_index - 1) * chunk_size)
                       )
          ) %>%
      content("text") %>%
      fromJSON() %>%
      as_tibble()
    
    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size
    loop_index = loop_index + 1
  }
  
  all_inspections
  
}

url = "https://data.cityofnewyork.us/resource/9w7m-hzhe.json"

rest_inspection = get_all_inspections(url) %>%
  bind_rows() 
```

```{r reading and cleaning the health indicator data}
download.file("https://www1.nyc.gov/assets/doh/downloads/excel/episrv/2015_CHP_PUD.xlsx", mode="wb", destfile = "health.xlsx")
health <- read_excel("health.xlsx", sheet = "CHP_all_data") %>% 
  select(Name, Racewhite_Rate, Age0to17_rate, 
         Age18to24_rate, Age25to44_rate, Poverty, Unemployment,
         Smoking, Exercise,
         Obesity, Diabetes, Stroke_Hosp) %>% 
  clean_names() %>% 
  mutate(age0to44_rate = age0to17_rate + age18to24_rate + age25to44_rate) %>% 
  select(-age0to17_rate, -age18to24_rate, -age25to44_rate)
  
```

## Percentage of fast food restaurant in different neighborhood (approached by cuisine type)

```{r defining_fastfood}
rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)
```

```{r counting_fastfood}
name_boro = c("MANHATTAN", "BROOKLYN", "QUEENS", "BRONX", "STATEN ISLAND")

n_rest = function(name_boro){
  
  rest_boro =
    rest_inspection %>%
    filter(boro == name_boro) %>%
    distinct(camis)
  
  n_rest = nrow(rest_boro)

  n_rest    
} 

rest_fastfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Bagels/Pretzels",
                                    "Bottled beverages, including water, sodas, juices, etc.",
                                    "Chicken",
                                    "Delicatessen",
                                    "Donuts",
                                    "Hamburgers",
                                    "Hotdogs",
                                    "Hotdogs/Pretzels",
                                    "Ice Cream, Gelato, Yogurt, Ices",
                                    "Nuts/Confectionary",
                                    "Pancakes/Waffles",
                                    "Pizza",
                                    "Soul Food",
                                    "Sandwiches",
                                    "Sandwiches/Salads/Mixed Buffet",
                                    "Soups & Sandwiches"))

n_fastfood = function(name_boro){
  
  rest_fastfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_fastfood = nrow(rest_fastfood_distinct)
  
  n_fastfood
}

percent_fastfood = function(name_boro){
  
  percent_fastfood = n_fastfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    percent_fastfood = percent_fastfood
  )
}

map(name_boro, percent_fastfood) %>%
  bind_rows()
```

## Percentage of inspection grades in different boroughs
```{r grade_percentage}
rest_inspection %>%
  group_by(boro, grade) %>%
  summarise(n = n()) %>%
  mutate(grade_percent = n / sum(n))

```


<<<<<<< HEAD

## Percentage of 
```{r}

```


## linear regression of percentage of chain restaurants in boroughs and health 
```{r}

```

=======
## Healthy food restaurant in different neighborhood (Intuitively approached by cuisine type)

```{r healthy_restaurant}
rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)

rest_healthyfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Fruits/Vegetables",
                                    "Juice, Smoothies, Fruit Salads",
                                    "Salads",
                                    "Vegetarian",
                                    "Soups")) 

rest_healthyfood %>%
  distinct(camis, dba, boro, cuisine_description) %>%
  group_by(boro) %>%
  summarize(n = n())

n_healthyfood = function(name_boro){
  
  rest_healthyfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_healthyfood = nrow(rest_healthyfood_distinct)
  
  n_healthyfood
}

percent_healthyfood = function(name_boro){
  
  percent_healthyfood = n_healthyfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    percent_healthyfood = percent_healthyfood
  )
}

map(name_boro, percent_healthyfood) %>%
  bind_rows()
>>>>>>> 1b73c81e90c21625f0dbdd19f382999e7cb062de
```

## Matching list of chain restaurants in U.S. and restaurant inspection data

```{r reading_rest_chains_wiki}
library(stringr)

chains_html = read_html("https://en.wikipedia.org/wiki/List_of_restaurant_chains_in_the_United_States#Fast-casual")

chain_rest = chains_html %>%
  html_nodes("ul:nth-child(9) li , .jquery-tablesorter tr:nth-child(1) td:nth-child(1)") %>%
  html_text() %>%
  as.tibble() %>%
  mutate(dba = value, 
         dba = str_to_upper(dba)) %>%
  select(dba)
# read in the list of chain restaurants in us 
# made the names to uppercase and changed the var name to dba
```

```{r matching_with_inspection}
# removing punctuations in chain_rest & restaurant inspections
chain_rest_str = 
  chain_rest  %>%
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))

rest_inspect_str = rest_inspection %>% 
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))

# Matching the two datasets(restaurant inspection data that has all punctuation removed from dba(restaurant name) and list of chain restaurants by dba)
nyc_chain = 
right_join(rest_inspect_str, chain_rest_str) %>%
filter(!is.na(camis)) %>%
  distinct(camis, dba, boro)

# How many mcdonalds?
nyc_chain %>%
  filter(str_detect(dba, regex("^MCDON")))
#207
```

Trying out fuzzy join but I think fuzzy join is worse.

```{r testing fuzzy join}
# fuzzy join
library(fuzzyjoin)

rest_inspection_join = 
  rest_inspection %>%
  filter(!is.na(dba))
  
nyc_chain_2 = stringdist_right_join(rest_inspection_join, chain_rest, by = "dba", max_dist = 1) %>%
  filter(!is.na(camis))

nyc_chain_2 %>%
  select(dba.x, dba.y) %>%
  distinct()

nyc_chain_2 %>%
 filter(str_detect(dba.x, regex("^MCDON")))

```

Next is calculating the percentage of chain restaurants in each boro.

```{r percentage_chains_boro}
# counting chains in boro
count_chain = nyc_chain %>%
  group_by(boro) %>%
  summarise(chain_n = n())

count_rest = rest_inspection %>%
  distinct(boro, camis) %>%
  group_by(boro) %>%
  summarise(res_n = n())

# calculating percentage of chains in each boro
percent_chain = left_join(count_chain, count_rest) %>%
  mutate(chain_percentage = chain_n/res_n)
```

## Linear regression of health data on percentage of chain restaurants in each borough

```{r combining health data with percentage of chains}
health_join = health %>% mutate(boro = str_to_upper(name))
health_chain_join = left_join(percent_chain, health_join, by = "boro") 
  
# function for modeling health outcome and percentage of chain restaurants

# first function graphs_health will give a graph of health oucomes in different borougs to show you the how severity of health outcomes differ between boroughs
graphs_health = function(health){
  health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, health)) %>%
   ggplot(aes(boro, health, color = boro)) + geom_point()
}  

# second function graphs_health will give a graph showing the relationship between health outcomes in boroughs and their percentage of chain restaurants
graphs_chain_health = function(df, health){
  mutate(df, boro = forcats::fct_reorder(boro, health)) %>%
  ggplot(aes(chain_percentage, obesity, color = boro)) + geom_point()
  }

# third function gives an output of the linear regression result
reg_chain = function(health){
  lm(health ~ chain_percentage, data = health_chain_join) %>%
  summary()
  }
```

```{r model obesity vs percentage of chains}
# model obesity
health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, obesity)) %>%
   ggplot(aes(boro, obesity, color = boro)) + geom_point()

health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, obesity)) %>%
  ggplot(aes(chain_percentage, obesity, color = boro)) + geom_point()

lm(obesity ~ chain_percentage, data = health_chain_join) %>%
  summary()

graphs_chain_health(obesity)
```


```{r model diabetes vs percentage of chains}
# model diabetes
health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, diabetes)) %>%
   ggplot(aes(boro, diabetes, color = boro)) + geom_point()

health_chain_join %>%
   mutate(boro = forcats::fct_reorder(boro, diabetes)) %>%
  ggplot(aes(chain_percentage, diabetes, color = boro)) + geom_point()

lm(diabetes ~ chain_percentage, data = health_chain_join) %>%
  summary()
```

```{r model stroke vs percentage of chains}
# model diabetes
health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, stroke_hosp)) %>%
   ggplot(aes(boro, diabetes, color = boro)) + geom_point()

health_chain_join %>%
   mutate(boro = forcats::fct_reorder(boro, stroke_hosp)) %>%
  ggplot(aes(chain_percentage, diabetes, color = boro)) + geom_point()

lm(stroke_hosp ~ chain_percentage, data = health_chain_join) %>%
  summary()
```