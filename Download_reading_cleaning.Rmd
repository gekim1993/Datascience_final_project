---
title: "Reading_dataset"
author: "Junting Ren"
date: "November 20, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(readxl)
library(data.table)
library(stringr)
library(janitor)
```

```{r reading the New York Inspection data}
library(tidyverse)
library(httr)
library(jsonlite)

get_all_inspections = function(url) {
  
  all_inspections = vector("list", length = 0)
  
  loop_index = 1
  chunk_size = 50000
  DO_NEXT = TRUE
  
  while (DO_NEXT) {
    message("Getting data, page ", loop_index)
    
    all_inspections[[loop_index]] = 
      GET(url,
          query = list(`$order` = "zipcode",
                       `$limit` = chunk_size,
                       `$offset` = as.integer((loop_index - 1) * chunk_size)
                       )
          ) %>%
      content("text") %>%
      fromJSON() %>%
      as_tibble()
    
    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size
    loop_index = loop_index + 1
  }
  
  all_inspections
  
}

url = "https://data.cityofnewyork.us/resource/9w7m-hzhe.json"

rest_inspection = get_all_inspections(url) %>%
  bind_rows() 
```

```{r reading and cleaning the health indicator data}
download.file("https://www1.nyc.gov/assets/doh/downloads/excel/episrv/2015_CHP_PUD.xlsx", mode="wb", destfile = "health.xlsx")
health <- read_excel("health.xlsx", sheet = "CHP_all_data") %>% 
  select(Name, Racewhite_Rate, Age0to17_rate, 
         Age18to24_rate, Age25to44_rate, Poverty, Unemployment,
         Smoking, Exercise,
         Obesity, Diabetes, Stroke_Hosp) %>% 
  clean_names() %>% 
  mutate(age0to44_rate = age0to17_rate + age18to24_rate + age25to44_rate) %>% 
  select(-age0to17_rate, -age18to24_rate, -age25to44_rate)
  
```

## Percentage of fast food restaurant in different neighborhood (approached by cuisine type)

```{r defining_fastfood, include = FALSE}
rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)
```

```{r counting_fastfood}
name_boro = c("MANHATTAN", "BROOKLYN", "QUEENS", "BRONX", "STATEN ISLAND")

n_rest = function(name_boro){
  
  rest_boro =
    rest_inspection %>%
    filter(boro == name_boro) %>%
    distinct(camis)
  
  n_rest = nrow(rest_boro)

  n_rest    
} 

rest_fastfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Bagels/Pretzels",
                                    "Bottled beverages, including water, sodas, juices, etc.",
                                    "Chicken",
                                    "Delicatessen",
                                    "Donuts",
                                    "Hamburgers",
                                    "Hotdogs",
                                    "Hotdogs/Pretzels",
                                    "Ice Cream, Gelato, Yogurt, Ices",
                                    "Nuts/Confectionary",
                                    "Pancakes/Waffles",
                                    "Pizza",
                                    "Soul Food",
                                    "Sandwiches",
                                    "Sandwiches/Salads/Mixed Buffet",
                                    "Soups & Sandwiches"))

n_fastfood = function(name_boro){
  
  rest_fastfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_fastfood = nrow(rest_fastfood_distinct)
  
  n_fastfood
}

percent_fastfood = function(name_boro){
  
  percent_fastfood = n_fastfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    percent_fastfood = percent_fastfood
  )
}

fastfood_boro=
  map(name_boro, percent_fastfood) %>%
  bind_rows()
```

<<<<<<< .merge_file_BBNPb5
```{r}
health_boro =
  health %>%
  clean_names() %>%
  mutate(name = str_to_upper(name)) %>%
  rename(boro = name)

combined_boro = 
  left_join(fastfood_boro, health_boro, by = "boro")
```

Obesity ~ Percent of fast food restaurants

```{r}
lm(obesity ~ percent_fastfood, combined_boro) %>%
  broom::tidy()
```

Diabetes ~ Percent of fast food restaurants

```{r}
lm(diabetes ~ percent_fastfood, combined_boro) %>%
  broom::tidy()
```

Hospitalized Stroke ~ Percent of fast food restaurants

```{r}
lm(stroke_hosp ~ percent_fastfood, combined_boro) %>%
  broom::tidy()
```

=======
## Percentage of inspection grades in different boroughs
```{r grade_percentage}
data =
  rest_inspection %>%
  group_by(boro, grade) %>%
  summarise(n = n()) %>%
  mutate(grade_percent = n / sum(n)) %>% 
  filter(grade == "A")

data1 = health filter(name == "Manhattan", "Bronx")

```


<<<<<<< HEAD

## Percentage of 
```{r}

```


## linear regression of percentage of chain restaurants in boroughs and health 
```{r}

```

=======
>>>>>>> .merge_file_nMzp6S
## Healthy food restaurant in different neighborhood (Intuitively approached by cuisine type)

```{r healthy_restaurant}
rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)

rest_healthyfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Fruits/Vegetables",
                                    "Juice, Smoothies, Fruit Salads",
                                    "Salads",
                                    "Vegetarian",
                                    "Soups")) 

rest_healthyfood %>%
  distinct(camis, dba, boro, cuisine_description) %>%
  group_by(boro) %>%
  summarize(n = n())

n_healthyfood = function(name_boro){
  
  rest_healthyfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_healthyfood = nrow(rest_healthyfood_distinct)
  
  n_healthyfood
}

percent_healthyfood = function(name_boro){
  
  percent_healthyfood = n_healthyfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    percent_healthyfood = percent_healthyfood
  )
}

map(name_boro, percent_healthyfood) %>%
  bind_rows()
>>>>>>> 1b73c81e90c21625f0dbdd19f382999e7cb062de
```

## Matching list of chain restaurants in us and restaurant inspection data
```{r reading_rest_chains_wiki}
library(stringr)

chains_html = read_html("https://en.wikipedia.org/wiki/List_of_restaurant_chains_in_the_United_States#Fast-casual")

chain_rest = chains_html %>%
  html_nodes("ul:nth-child(9) li , .jquery-tablesorter tr:nth-child(1) td:nth-child(1)") %>%
  html_text() %>%
  as.tibble() %>%
  mutate(dba = value, 
         dba = str_to_upper(dba)) %>%
  select(dba)
# read in the list of chain restaurants in us 
# made the names to uppercase and changed the var name to dba
```

```{r matching_with_inspection}
# removing punctuations in chain_rest & restaurant inspections
chain_rest_str = 
  chain_rest  %>%
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))

rest_inspect_str = rest_inspection %>% 
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))
  
nyc_chain = 
right_join(rest_inspect_str, chain_rest_str) %>%
filter(!is.na(camis)) %>%
  distinct(camis, dba, boro)

# How many mcdonalds?
nyc_chain %>%
  filter(str_detect(dba, regex("^MCDON")))
#207
```

I think fuzzy join is worse.

```{r testing fuzzy join}
# fuzzy join
library(fuzzyjoin)

rest_inspection_join = 
  rest_inspection %>%
  filter(!is.na(dba))
  
nyc_chain_2 = stringdist_right_join(rest_inspection_join, chain_rest, by = "dba", max_dist = 1) %>%
  filter(!is.na(camis))

nyc_chain_2 %>%
  select(dba.x, dba.y) %>%
  distinct()

nyc_chain_2 %>%
 filter(str_detect(dba.x, regex("^MCDON")))

```



