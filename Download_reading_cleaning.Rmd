---
title: "Final project: The relationship between restaurant geographical distribution and chronic disease outcomes in New York City"
author: "Gaeun Kim(gk2501); Junting Ren(jr3755);  Leyiyu Yue(ly2428); Ruiwei Zhang(rz2375) ; "
date: "November 20, 2017"
output: 
   html_document:
    toc: true
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rvest)
library(httr)
library(readxl)
library(data.table)
library(stringr)
library(janitor)
library(stringr)
library(forcats)
```

```{r reading the New York Inspection data}
library(tidyverse)
library(httr)
library(jsonlite)

get_all_inspections = function(url) {
  
  all_inspections = vector("list", length = 0)
  
  loop_index = 1
  chunk_size = 50000
  DO_NEXT = TRUE
  
  while (DO_NEXT) {
    message("Getting data, page ", loop_index)
    
    all_inspections[[loop_index]] = 
      GET(url,
          query = list(`$order` = "zipcode",
                       `$limit` = chunk_size,
                       `$offset` = as.integer((loop_index - 1) * chunk_size)
                       )
          ) %>%
      content("text") %>%
      fromJSON() %>%
      as_tibble()
    
    DO_NEXT = dim(all_inspections[[loop_index]])[1] == chunk_size
    loop_index = loop_index + 1
  }
  
  all_inspections
  
}

url = "https://data.cityofnewyork.us/resource/9w7m-hzhe.json"

rest_inspection = get_all_inspections(url) %>%
  bind_rows() 
```

```{r reading and cleaning the health indicator data}
download.file("https://www1.nyc.gov/assets/doh/downloads/excel/episrv/2015_CHP_PUD.xlsx", mode="wb", destfile = "health.xlsx")
health <- read_excel("health.xlsx", sheet = "CHP_all_data") %>% 
  select(Name, Racewhite_Rate, Age0to17_rate, 
         Age18to24_rate, Age25to44_rate, Poverty, Unemployment,
         Smoking, Exercise,
         Obesity, Diabetes, Stroke_Hosp) %>% 
  clean_names() %>% 
  mutate(age0to44_rate = age0to17_rate + age18to24_rate + age25to44_rate) %>% 
  select(-age0to17_rate, -age18to24_rate, -age25to44_rate)
  
```

##Health data exploratory in different neighborhood
```{r}
health_only_neighborhood <- health[-c(1:6),] %>% 
  rename(neighborhood = name) %>% 
  mutate(neighborhood = as.factor(neighborhood))
##Plotting for outcome in different neighborhood

###Williamsbridge and Baychester have the highest obesity rate, up to 32%
health_only_neighborhood %>%
  mutate(neighborhood = fct_reorder(neighborhood, obesity)) %>% 
  filter(obesity > 25) %>% 
<<<<<<< HEAD
  ggplot(aes(x = neighborhood,y = obesity)) + geom_col() +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
=======
  ggplot(aes(x = neighborhood,y = obesity, fill = neighborhood)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f
  labs(title = "Neighborhood with 25 percent more obesity rate")

###East New York and Starrett City have the highest diabetes rate, up to 17 percent
health_only_neighborhood %>%
  mutate(neighborhood = fct_reorder(neighborhood, diabetes)) %>% 
  filter(diabetes > 10) %>% 
<<<<<<< HEAD
  ggplot(aes(x = neighborhood,y = diabetes)) + geom_col() +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
=======
  ggplot(aes(x = neighborhood,y = diabetes, fill = neighborhood)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f
  labs(title = "Neighborhood with 10 percent more diabetes rate")

###BUshwick has the highest stroke hospitalization in 100,000 adults, up to 300 adults
health_only_neighborhood %>%
  mutate(neighborhood = fct_reorder(neighborhood, stroke_hosp)) %>% 
  filter(stroke_hosp > 300) %>% 
<<<<<<< HEAD
  ggplot(aes(x = neighborhood,y = stroke_hosp)) + geom_col() +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
=======
  ggplot(aes(x = neighborhood,y = stroke_hosp, fill = neighborhood)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f
  labs(title = "Neighborhood with 300 more stroke hospitalization in 100,000 adults")



##Plotting for some adjusted variables

###Morrisania and Crotona has the highest percent of poverty rate, up to 40%
health_only_neighborhood %>%
  mutate(neighborhood = fct_reorder(neighborhood, poverty)) %>% 
  filter(poverty > 20) %>% 
<<<<<<< HEAD
  ggplot(aes(x = neighborhood,y = poverty)) + geom_col() +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
=======
  ggplot(aes(x = neighborhood,y = poverty, fill = neighborhood)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f
  labs(title = "Neighborhood with 20 percent or more poverty")

###Fiancial district has the highest percent of young peoeple, up to 67%
health_only_neighborhood %>%
  mutate(neighborhood = fct_reorder(neighborhood, age0to44_rate)) %>% 
  filter(age0to44_rate > 60) %>% 
<<<<<<< HEAD
  ggplot(aes(x = neighborhood,y = age0to44_rate)) + geom_col() +  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
=======
  ggplot(aes(x = neighborhood,y = age0to44_rate, fill = neighborhood)) + geom_col() +  
  theme(axis.text.x = element_text(angle = 45, hjust = 1), legend.position = "none") +
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f
  labs(title = "Neighborhood with 60 percent or more people under age 44")


```


## Percentage of fast food restaurant in different boro/neighborhood (approached by cuisine type)

```{r defining_fastfood}
# Identify fastfood restaurants by their cuisine types. We print out the cuisine type list (n=85) and let everyone circle the ones they think is fastfood and we use the union as our rule (use union because it's more conservative).

rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)
```

```{r counting_fastfood_boro}
# calculating the taotal number of restaurants and the number of fastfood restaurants in the boro, as well as the percentage of fastfood restaurants.

name_boro = c("MANHATTAN", "BROOKLYN", "QUEENS", "BRONX", "STATEN ISLAND")

n_rest = function(name_boro){
  
  rest_boro =
    rest_inspection %>%
    filter(boro == name_boro) %>%
    distinct(camis)
  
  n_rest = nrow(rest_boro)

  n_rest    
} 

rest_fastfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Bagels/Pretzels",
                                    "Bottled beverages, including water, sodas, juices, etc.",
                                    "Chicken",
                                    "Delicatessen",
                                    "Donuts",
                                    "Hamburgers",
                                    "Hotdogs",
                                    "Hotdogs/Pretzels",
                                    "Ice Cream, Gelato, Yogurt, Ices",
                                    "Nuts/Confectionary",
                                    "Pancakes/Waffles",
                                    "Pizza",
                                    "Soul Food",
                                    "Sandwiches",
                                    "Sandwiches/Salads/Mixed Buffet",
                                    "Soups & Sandwiches"))

n_fastfood = function(name_boro){
  
  rest_fastfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_fastfood = nrow(rest_fastfood_distinct)
  
  n_fastfood
}

percent_fastfood = function(name_boro){
  
  percent_fastfood = n_fastfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    n_fastfood = n_fastfood(name_boro),
    n_rest = n_rest(name_boro),
    percent_fastfood = percent_fastfood
  )
}

fastfood_boro = 
  map(name_boro, percent_fastfood) %>%
  bind_rows()

# summary for restaurant data for neighborhood

fastfood_boro %>%
  mutate(boro = as.factor(boro),
         boro = fct_relevel(boro, n_fastfood)) %>%
  ggplot(aes(x = boro, y = n_fastfood)) +
  geom_bar(stat = "count")

# combine the dataset with health data and run linear simple regression models

health_boro = 
  health %>%
  mutate(boro = str_to_upper(name)) %>%
  select(-name)

combined_boro = 
  left_join(fastfood_boro, health_boro, by = "boro")

lm(obesity ~ percent_fastfood, combined_boro) %>%
  broom::tidy()

lm(diabetes ~ percent_fastfood, combined_boro) %>%
  broom::tidy()

lm(stroke_hosp ~ percent_fastfood, combined_boro) %>%
  broom::tidy()
```

```{r counting_fastfood_neighborhood}
# calculating the taotal number of restaurants and the number of fastfood restaurants in the neighborhood, as well as the percentage of fastfood restaurants.

neighborhood_list = 
  rest_neighborhood %>%
  distinct(neighborhood) %>%
  arrange(neighborhood)
  
n_rest_neighborhood = function(name_neighborhood){
  
  rest_each_neighborhood =
    rest_neighborhood %>%
    filter(neighborhood == name_neighborhood) %>%
    distinct(camis)
  
  n_rest_neighborhood = nrow(rest_each_neighborhood)

  n_rest_neighborhood    
} 

rest_fastfood_neighborhood = 
  rest_neighborhood %>%
  filter(cuisine_description %in% c("Bagels/Pretzels",
                                    "Bottled beverages, including water, sodas, juices, etc.",
                                    "Chicken",
                                    "Delicatessen",
                                    "Donuts",
                                    "Hamburgers",
                                    "Hotdogs",
                                    "Hotdogs/Pretzels",
                                    "Ice Cream, Gelato, Yogurt, Ices",
                                    "Nuts/Confectionary",
                                    "Pancakes/Waffles",
                                    "Pizza",
                                    "Soul Food",
                                    "Sandwiches",
                                    "Sandwiches/Salads/Mixed Buffet",
                                    "Soups & Sandwiches"))

n_fastfood_neighborhood = function(name_neighborhood){
  
  rest_fastfood_distinct_neighborhood = 
    rest_fastfood_neighborhood %>%
    filter(neighborhood == name_neighborhood) %>%
    distinct(camis, cuisine_description)
  
  n_fastfood_neighborhood = nrow(rest_fastfood_distinct_neighborhood)
  
  n_fastfood_neighborhood
}

percent_fastfood_neighborhood = function(name_neighborhood){
  
  percent_fastfood_neighborhood = n_fastfood_neighborhood(name_neighborhood)/n_rest_neighborhood(name_neighborhood)
  
  tibble(
    neighborhood = name_neighborhood,
    n_fastfood = n_fastfood_neighborhood(name_neighborhood),
    n_rest = n_rest_neighborhood(name_neighborhood),
    percent_fastfood = percent_fastfood_neighborhood
  )
}

fastfood_neighborhood = 
  map(neighborhood_list$neighborhood, percent_fastfood_neighborhood) %>%
  bind_rows() %>%
  mutate(neighborhood = str_to_upper(neighborhood))

# summary for restaurant data for neighborhood



# combine the dataset with health data and run linear simple regression models

health_neighborhood = 
  health %>%
  mutate(neighborhood = str_to_upper(name)) %>%
  select(-name)

combined_neighborhood = 
  left_join(fastfood_neighborhood, health_neighborhood, by = "neighborhood")

lm(obesity ~ percent_fastfood + racewhite_rate + age0to44_rate + poverty + smoking + exercise, combined_neighborhood) %>%
  broom::tidy()

lm(diabetes ~ percent_fastfood + racewhite_rate + age0to44_rate + poverty + smoking + exercise, combined_neighborhood) %>%
  broom::tidy()

lm(stroke_hosp ~ percent_fastfood + racewhite_rate + age0to44_rate + poverty + smoking + exercise, combined_neighborhood) %>%
  broom::tidy()
```

## Percentage of inspection grades in different boroughs
```{r grade_percentage}
data =
  rest_inspection %>%
  group_by(boro, grade) %>%
  summarise(n = n()) %>%
  mutate(grade_percent = n / sum(n)) %>% 
  filter(grade == "A")
```

```{r}
combined = 
  left_join(data, health_boro, by = "boro") %>% 
  filter(boro!="Missing")
```
First, combine the data which we substract from the data of each borough of our "health" data with the dataset which shows the percentage of "grade-A" restaurants in each borough. Then we acquire the final dataset we can do the linear regression between obesity, diabetes and stroke with the percentage of "grade-A" restaurants, which we treat as a represent of the healthy restaurants in that borough.
```{r}
reg1 <- lm(obesity ~ grade_percent, data = combined )
summary(reg1)
broom::tidy(reg1)
```
p-value is way much higher than 0.05, fail to reject the null, meaning that there is no linear association between the obesity and the percentage of grade A restaurant in each borough.
```{r}
reg2 <- lm(diabetes ~ grade_percent, data = combined )
summary(reg2)
broom::tidy(reg2)
```
p-value is way much higher than 0.05, fail to reject the null, meaning that there is no linear association between the diabetes and the percentage of grade A restaurant in each borough.
```{r}
reg3 <- lm(stroke_hosp ~ grade_percent, data = combined )
summary(reg3)
broom::tidy(reg3)
```
p-value is way much higher than 0.05, fail to reject the null, meaning that there is no linear association between the stroke and the percentage of grade A restaurant in each borough.  
According to the three linear regression analysis above, we can conclude that there is no linear relationship between obesity, diabetes and stroke with the "grade-A" restaurants in each borough.

## Percentage of 
```{r}

```


## linear regression of percentage of chain restaurants in boroughs and health 
```{r}

```

## Healthy food restaurant in different neighborhood (Intuitively approached by cuisine type)

```{r healthy_restaurant}
rest_inspection %>%
  mutate(dba = str_to_upper(dba)) %>%
  arrange(cuisine_description) %>%
  count(cuisine_description)

rest_healthyfood = 
  rest_inspection %>%
  filter(cuisine_description %in% c("Fruits/Vegetables",
                                    "Juice, Smoothies, Fruit Salads",
                                    "Salads",
                                    "Vegetarian",
                                    "Soups")) 

rest_healthyfood %>%
  distinct(camis, dba, boro, cuisine_description) %>%
  group_by(boro) %>%
  summarize(n = n())

n_healthyfood = function(name_boro){
  
  rest_healthyfood_distinct = 
    rest_fastfood %>%
    filter(boro == name_boro) %>%
    distinct(camis, cuisine_description)
  
  n_healthyfood = nrow(rest_healthyfood_distinct)
  
  n_healthyfood
}

percent_healthyfood = function(name_boro){
  
  percent_healthyfood = n_healthyfood(name_boro)/n_rest(name_boro)
  
  tibble(
    boro = name_boro,
    percent_healthyfood = percent_healthyfood
  )
}

map(name_boro, percent_healthyfood) %>%
  bind_rows()
```

## Matching list of chain restaurants in U.S. and restaurant inspection data

```{r reading_rest_chains_wiki}
library(stringr)

chains_html = read_html("https://en.wikipedia.org/wiki/List_of_restaurant_chains_in_the_United_States#Fast-casual")

chain_rest = chains_html %>%
  html_nodes("ul:nth-child(9) li , .jquery-tablesorter tr:nth-child(1) td:nth-child(1)") %>%
  html_text() %>%
  as.tibble() %>%
  mutate(dba = value, 
         dba = str_to_upper(dba)) %>%
  select(dba)
# read in the list of chain restaurants in us 
# made the names to uppercase and changed the var name to dba
```

```{r matching_with_inspection}
# removing punctuations in chain_rest & restaurant inspections
chain_rest_str = 
  chain_rest  %>%
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))

rest_inspect_str = rest_inspection %>% 
  mutate(dba = str_replace_all(dba, "[[:punct:]]", ""))

# Matching the two datasets(restaurant inspection data that has all punctuation removed from dba(restaurant name) and list of chain restaurants by dba)
nyc_chain = 
  right_join(rest_inspect_str, chain_rest_str) %>%
  filter(!is.na(camis)) %>%
  distinct(camis, dba, boro)

# How many mcdonalds?
nyc_chain %>%
  filter(str_detect(dba, regex("^MCDON")))
#207
```

Trying out fuzzy join but I think fuzzy join is worse.

```{r testing fuzzy join}
# fuzzy join
library(fuzzyjoin)

rest_inspection_join = 
  rest_inspection %>%
  filter(!is.na(dba))

nyc_chain_2 = stringdist_right_join(rest_inspection_join, chain_rest, by = "dba", max_dist = 1) %>%
  filter(!is.na(camis))

nyc_chain_2 %>%
  select(dba.x, dba.y) %>%
  distinct()

nyc_chain_2 %>%
  filter(str_detect(dba.x, regex("^MCDON")))

```

Next is calculating the percentage of chain restaurants in each boro.

```{r percentage_chains_boro}
# counting chains in boro
count_chain = nyc_chain %>%
  group_by(boro) %>%
  summarise(chain_n = n())

count_rest = rest_inspection %>%
  distinct(boro, camis) %>%
  group_by(boro) %>%
  summarise(res_n = n())

# calculating percentage of chains in each boro
percent_chain = left_join(count_chain, count_rest) %>%
  mutate(chain_percentage = chain_n/res_n)
```

## Linear regression of health data on percentage of chain restaurants in each borough

```{r combining health data with percentage of chains}
health_join = health %>% mutate(boro = str_to_upper(name))
health_chain_join = left_join(percent_chain, health_join, by = "boro") 

# function for modeling health outcome and percentage of chain restaurants

lm_sum = function(health_outcome){
  graphs_health = health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, health_outcome)) %>%
   ggplot(aes(boro, health_outcome, color = boro)) + geom_point()

 graphs_chain_health = health_chain_join %>%
  mutate(boro = forcats::fct_reorder(boro, health_outcome)) %>%
  ggplot(aes(chain_percentage, health_outcome, color = boro)) + geom_point()
 
 reg_chain = lm(health_outcome ~ chain_percentage, data = health_chain_join) %>%

list(graphs_health, graphs_chain_health, reg_chain)
# function that takes a input of column in health_chain_join and gives output of
# 1. graphs_health will give a graph of health oucomes in different borougs to show you the how severity of health outcomes differ between boroughs

# 2. graphs_health will give a graph showing the relationship between health outcomes in boroughs and their percentage of chain restaurants

# 3.reg_chain gives an output of the linear regression result
}

```

```{r model obesity vs percentage of chains}
# model obesity
lm_sum(health_chain_join$obesity)
```
The chain_percentage-health_outcome graph shows the relationship between obesity and borough's percetage of chain restaurants. It shows a slightly positive linear trend except for Brooklyn, which has the lowest percentage of health restaurants but third highest in percentage of obesity rate.

In the linear regression analysis,the p-value for the slope coeffcient, is 0.309, indicating that 0.05 significance level, there is no linear association between percentage of obesity in boroughs and their percentage of chain restaurants.

```{r model diabetes vs percentage of chains}
# model diabetes
lm_sum(health_chain_join$diabetes)
```
Percentage of diabetes and chain restaurants seems to have a lower association when visualizing the relationship. In the linear regression analysis,the p-value for the slope coeffcient, is 0.546, indicating that 0.05 significance level, there is no linear association between percentage of diabetes in boroughs and their percentage of chain restaurants.

```{r model stroke vs percentage of chains}
# model stroke
lm_sum(health_chain_join$stroke_hosp)
```
Percentage of diabetes and chain restaurants seems to have a lower association when visualizing the relationship. In the linear regression analysis,the p-value for the slope coeffcient, is 0.546, indicating that 0.05 significance level, there is no linear association between percentage of diabetes in boroughs and their percentage of chain restaurants. 

## Linear regression of health data on percentage of chain restaurants in each neighbourhood

##Analysis for restaurant data by neighborhood

```{r merging the neighborhood data with restaurant data}
zip_neighbor <- read_csv("neigh_zipcode.csv") %>% 
  mutate(zipcode = as.character(zipcode))
##restaurant data with neighbourhood
rest_neighborhood = left_join(rest_inspection, zip_neighbor, by = "zipcode") %>% 
  filter(!is.na(neighborhood))
```
<<<<<<< HEAD


<<<<<<< HEAD
<<<<<<< HEAD

=======
>>>>>>> c36fea8a5b240de682da850dbe3bddbf55f77937
=======
>>>>>>> f2af75f4116094ca411f1265f574e70f603d482f

```{r}
library(tidyverse)
library(stringr)
library(forcats)
library(viridis)
library(plotly)
library(Rmisc)
library(ggplot2)

explore_boro = health[c(2:6),] %>% 
  mutate(name = as.factor(name)) %>% 
  data.frame()


  explore_boro %>%
  mutate(name = fct_reorder(name,obesity)) %>% 
  plot_ly(x = ~name, y = ~obesity, color = ~name, type = "bar")
  # for obesity.


  explore_boro %>% 
  mutate(name = fct_reorder(name,diabetes)) %>%
  plot_ly(x = ~name, y = ~diabetes, color = ~name, type = "bar")
  # for diabetes.


  explore_boro %>% 
  mutate(name = fct_reorder(name,stroke_hosp)) %>%
  plot_ly(x = ~name, y = ~stroke_hosp, color = ~name, type = "bar")
  # for stroke.

```
For obesity, Manhattan has lowerest percentage. Bronx has the highest. And there are increasing obesity percentages as the order of Queens, Brooklyn and Staten Island. For diabetes, the lowest and highest are the same as those of obesity. The difference is that the percentages of Queens and Staten Island are nearly the same and a little bit lower than that of Brooklyn. For stroke, it has the same situation with that of diabetes.
=======
>>>>>>> 2ab930f11070c97f9f70749bca8f05feef2364b2
